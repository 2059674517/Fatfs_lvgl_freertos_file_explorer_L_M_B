
/**

  ******************************************************************

  * @file    core_delay.c

  * @author  fire

  * @version V1.0

  * @date    2018-xx-xx

  * @brief   ???????????

  ******************************************************************

  * @attention

  *

  * ????:?? STM32H743???  

  * ??    :http://www.firebbs.cn

  * ??    :https://fire-stm32.taobao.com

  *

  ******************************************************************

  */

#if 0

#include "core_delay.h"   


 

/*

**********************************************************************

*         ??????????

**********************************************************************

*/

/*

 ?Cortex-M????????DWT(Data Watchpoint and Trace),

 ??????32??????CYCCNT,??????????,

 ?????????????,?????????:

 10.74s=2?32??/400000000

 (???????400M,???????????1/400M=2.5ns)

 ?CYCCNT????,??0?????????

 ??CYCCNT???????:

 1????DWT??,????????????DEMCR??24??,?1??

 2???CYCCNT?????,??0

 3???CYCCNT???,???DWT_CTRL(???????DWT_CR)??0??,?1??

 */


 

#define  DWT_CR      *(__IO uint32_t *)0xE0001000

#define  DWT_CYCCNT  *(__IO uint32_t *)0xE0001004

#define  DEM_CR      *(__IO uint32_t *)0xE000EDFC


 

#define  DEM_CR_TRCENA                   (1 << 24)

#define  DWT_CR_CYCCNTENA                (1 <<  0)


 

/**

  * @brief  ??????

  * @param  ?

  * @retval ?

  * @note   ???????,???????

  */

HAL_StatusTypeDef HAL_InitTick(uint32_t TickPriority)

{

    /* ??DWT?? */

    DEM_CR |= (uint32_t)DEM_CR_TRCENA;                

    /* DWT CYCCNT??????0 */

    DWT_CYCCNT = (uint32_t)0u;

    /* ??Cortex-M DWT CYCCNT??? */

    DWT_CR |= (uint32_t)DWT_CR_CYCCNTENA;

  

    return HAL_OK;

}

/**

  * @brief  ???????

  * @param  ?

  * @retval ?????,?DWT_CYCCNT?????

  */

uint32_t CPU_TS_TmrRd(void)

{        

  return ((uint32_t)DWT_CYCCNT);

}

/**

  * @brief  ???????

  * @param  ?

  * @retval ?????,?DWT_CYCCNT?????

  */

uint32_t HAL_GetTick(void)

{        

  return ((uint32_t)DWT_CYCCNT/SysClockFreq*1000);

}


 

/**

  * @brief  ??CPU???????????,32????

  * @param  us : ????,??1 us

  * @retval ?

  * @note   ???????????CPU_TS_TmrInit???????,

            ????CPU_TS_INIT_IN_DELAY_FUNCTION

            ??????8?,?8*1000*1000

  */

void CPU_TS_Tmr_Delay_US(uint32_t us)

{

  uint32_t ticks;

  uint32_t told,tnow,tcnt=0;

  /* ??????????????, */  

#if (CPU_TS_INIT_IN_DELAY_FUNCTION)  

  /* ????????? */

  HAL_InitTick(5);

#endif

  

  ticks = us * (GET_CPU_ClkFreq() / 1000000);  /* ?????? */      

  tcnt = 0;

  told = (uint32_t)CPU_TS_TmrRd();         /* ????????? */

  while(1)

  {

    tnow = (uint32_t)CPU_TS_TmrRd();  

    if(tnow != told)

    { 

        /* 32?????????? */    

      if(tnow > told)

      {

        tcnt += tnow - told;  

      }

      /* ???? */

      else 

      {

        tcnt += UINT32_MAX - told + tnow; 

      } 

      

      told = tnow;

      /*????/????????,??? */

      if(tcnt >= ticks)break;

    }  

  }

}
#endif
/*********************************************END OF FILE**********************/

